<!doctype html>
<!--
    Cryptocurrency transaction monitoring thingy v0.1

    (c) 2015 by Robin Leffmann <djinn at stolendata dot net>

    https://github.com/stolendata/cctmt/

    licensed under CC BY-NC-SA 4.0 - http://creativecommons.org/licenses/by-nc-sa/4.0/
-->
<html lang="en">
<head>
<meta charset="utf-8" />
<link href="http://fonts.googleapis.com/css?family=Source+Code+Pro&subset=latin,latin-ext" rel="stylesheet" type="text/css" />
<title>Cryptocurrency transaction monitoring thingy</title>
<style type="text/css">
body { background-color: #202020;
       color: #ffffff;
       margin: 16px;
       font-size: 14px;
       font-family: "Source Code Pro", monospace; }
a { color: #ffffff;
    text-decoration: none; }
span.blob { color: #ffffff;
            font-size: 12px;
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            border: 0; }
span.purple { border-radius: 4px; background-image: linear-gradient( #724ccb, #4823a1 ); }
span.blue { border-radius: 10px; background-image: linear-gradient( #4c72cb, #2348a1 ); }
span.green { border-radius: 4px; background-image: linear-gradient( #62ab3c, #389113 ); }
span.gold { border-radius: 10px; background-image: linear-gradient( #c8a020, #685010 ); }
span.gray { color: #808080; border-radius: 10px; background-image: linear-gradient( #404040, #202020 ); }
</style>
<script type="text/javascript">
var currency = { 'BTC' : {'symbol':'\u0243', // \u0e3f
                          'ws':'wss://ws.blockchain.info/inv',
                          'eval_amount':'for( n in resp.x.out ) amount += resp.x.out[n].value;',
                          'tx_url':'https://blockchain.info/tx/',
                          'sub_tx':'{"op":"unconfirmed_sub"}',
                          'sub_block':'{"op":"blocks_sub"}'},
                 'LTC' : {'symbol':'\u0141',
                          'ws':'ws://ws.ltcchain.com:8000/inv',
                          'eval_amount':'for( n in resp.x.out ) amount += resp.x.out[n].value;',
                          'tx_url':'http://litechain.info/tx/',
                          'sub_tx':'{"op":"tx_sub"}',
                          'sub_block':'{"op":"block_sub"}'},
                 'DOGE' : {'symbol':'\u00d0',
                           'ws':'wss://ws.dogechain.info/inv',
                           'eval_amount':'amount = resp.x.value_out;',
                           'tx_url':'https://dogechain.info/tx/',
                           'sub_tx':'{"op":"unconfirmed_sub"}',
                           'sub_block':'{"op":"blocks_sub"}'},
                 'EUR' : '&euro;',
                 'USD' : '$' };
var c;
var f = 'USD'; // fixed USD fiat; chain.so doesn't relay any EUR rates yet

var items = new Array( 15 );
var coin = 100000000;
var last = 0, txc = 0, avg = 25;
var ws = to = null;

function get_rate()
{
    document.getElementById( 'exch' ).innerHTML = currency[c].symbol + '1 = ' + currency[f];

    if( to )
        clearTimeout( to );

    var xml = new XMLHttpRequest();
    xml.open( 'GET', 'https://chain.so/api/v2/get_price/' + c + '/' + f, false );
    xml.send( null );
    if( xml.status == '200' )
    {
        document.getElementById( 'rate' ).innerHTML = JSON.parse( xml.responseText ).data.prices[0].price;
        to = window.setTimeout( 'get_rate();', 1000 * 60 );
    }
}

function render()
{
    var out = '';
    for( var i = 0; i < items.length; i++ )
        out += ( items[i] ? items[i] : '' ) + '<br />';
    document.getElementById( 'tx' ).innerHTML = out;
}

function everything()
{
    document.getElementById( 'status' ).innerHTML = 'Connecting&hellip;';
    document.getElementById( 'rate' ).innerHTML = '&hellip;';
    c = document.getElementById( 'currency' ).value;
    items.unshift( '<span class="blob green">Now monitoring ' + c + '</span>' );
    items.pop();
    render();

    get_rate();

    ws = new WebSocket( currency[c].ws );
    last = txc = 0;
    document.getElementById( 'last' ).innerHTML = '&hellip;'

    ws.onopen = function()
    {
        document.getElementById( 'status' ).innerHTML = 'Connected!';
        ws.send( currency[c].sub_tx );
        ws.send( currency[c].sub_block );
    }

    ws.onmessage = function( r )
    {
//        console.log( r );
        var resp = JSON.parse( r.data );

        if( resp.op == 'status' )
            return;

        if( resp.op == 'block' )
            items.unshift( '<span class="blob green">' + c + ' #' + resp.x.height + '</span>' );
        else if( resp.op == 'utx' )
        {
            // eval total output
            var amount = 0;
            eval( currency[c].eval_amount );
            amount /= coin;

            // tx, ins->outs, amount
            items.unshift( '<span class="blob purple"><a href="' + currency[c].tx_url + resp.x.hash + '" target="_blank">' + resp.x.hash.substring( 0, 32 ) + '&hellip;</a></span> <span class="blob gray">' + resp.x.vin_sz + '\u2192' + resp.x.vout_sz + '</span> <span class="blob blue">' + currency[c].symbol + amount + '</span>' );

            // fiat value
            var rate = document.getElementById( 'rate' ).innerHTML;
            var fiat = amount * rate;
            last += fiat;
            items[0] += '<span class="blob gold">' + currency[f] + fiat.toFixed( fiat < 1 ? 5 : 2 ) + '</span>';

            if( ++txc % avg == 0 )
            {
                document.getElementById( 'last' ).innerHTML = currency[f] + +last.toFixed( 1 );
                last = 0;
            }
        }
        items.pop();
        render();
    }
}
</script>
</head>
<body onload="everything();" onbeforeunload="ws.close();">
<span id="status"></span> <a href="javascript:ws.close(); everything();">&#10227;</a> &middot; <select id="currency" onchange="ws.close(); everything();"><option value="BTC" selected>BTC</option><option value="LTC">LTC</option><option value="DOGE">DOGE</option></select> &middot; <span id="exch"></span><span id="rate"></span> &middot; Total output of last 25 transactions: <span id="last"></span><br /><br />
<span id="tx"></span><br />
<a href="https://github.com/stolendata/cctmt/">https://github.com/stolendata/cctmt/</a><br /><br />
BTC: 1EDhbo9ejdKUxNW3GPBh1UmocC1ea1TvE5<br />
LTC: LaDuRFwEt1V26pmJJH94auDvxqN3rRFqPj<br />
DOGE: DJ7vQ1dNRfebb1umVHsHxoMcd2Zq5L6LKp
</body>
</html>
